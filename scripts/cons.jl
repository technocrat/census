# SPDX-License-Identifier: MIT

const partialsdir(args...) = projectdir("_layout/partials", args...)

const concord    = ["CT", "MA", "ME", "NH", "RI", "VT"]
const cumber     = ["WV","KY","TN"]
const desert     = ["UT","MT","WY", "CO", "ID"]
const dixie      = ["NC", "SC", "FL", "GA","MS","AL"]
const factoria   = ["PA", "OH", "MI", "IN", "IL", "WI"]
const heartland  = ["MN","IA","NE", "ND", "SD", "KS", "MO"]
const lonestar   = ["TX","OK","AR","LA"]
const metropolis = ["DE", "MD","NY","NJ","VA","DC"]
const pacific    = ["WA","OR","AK"]
const sonora     = ["CA","AZ","NM","NV","HI"]
const nations    = [concord,cumber,desert,dixie,factoria,heartland,metropolis,pacific,sonora,lonestar]
const EU         = ["Austria", "Belgium", "Bulgaria", "Croatia", "Cyprus", "Czech Republic", "Denmark", "Estonia", "Finland", "France", "Germany", "Greece", "Hungary", "Ireland", "Italy", "Latvia", "Lithuania", "Luxembourg", "Malta", "Netherlands", "Poland", "Portugal", "Romania", "Slovak Republic", "Slovenia", "Spain", "Sweden"]
const conn       = LibPQ.Connection("dbname=geocoder")
const Titles     = ["Concordia","Cumberland","Deseret","New Dixie","Factoria","Heartlandia", "Metropolis", "Pacifica", "New Sonora", "The Lone Star Republic"]
const postals    = ["AK", "AL", "AR", "AZ", "CA", "CO", "CT", "DC", "DE", "FL", "GA", "HI", "IA", "ID", "IL", "IN", "KS", "KY", "LA", "MA", "MD", "ME", "MI", "MN", "MO", "MS", "MT", "NC", "ND", "NE", "NH", "NJ", "NM", "NV", "NY", "OH", "OK", "OR", "PA", "RI", "SC", "SD", "TN", "TX", "UT", "VA", "VT", "WA", "WI", "WV", "WY"]
const nat_names  = ["concord","cumber","desert","dixie","factoria","heartland","metropolis","pacifica","sonora","lonestar"]

map_colors = [
   colorant"#326313",  # FOREST_GREEN
   colorant"#74909a",  # SLATE_GREY
   colorant"#b6d1ba",  # SAGE_GREEN
   colorant"#d8bfd8",  # VIE_EN_ROSE
   colorant"#cfcfcf",  # LIGHT_GRAY
   colorant"#a0ced9",  # SKY_BLUE
   colorant"#486ab2"  # BRIGHT_BLUE
   ]

   # colorant"#fff626",  # KODAK_YELLOW
   # colorant"#ffffff"   # SNOW_WHITE
# R environment flag

const R_SETUP_COMPLETE = Ref(false)

# Define a set of all valid US state/territory postal codes
const VALID_POSTAL_CODES = Set([
    "AL", "AK", "AZ", "AR", "CA", "CO", "CT", "DE", "FL", "GA",
    "HI", "ID", "IL", "IN", "IA", "KS", "KY", "LA", "ME", "MD",
    "MA", "MI", "MN", "MS", "MO", "MT", "NE", "NV", "NH", "NJ",
    "NM", "NY", "NC", "ND", "OH", "OK", "OR", "PA", "RI", "SC",
    "SD", "TN", "TX", "UT", "VT", "VA", "WA", "WV", "WI", "WY",
    "DC" # District of Columbia
])

take_from_metro = ["24003", "24001", "24023", "36003", "36009", "36011", 
                   "36013", "36014", "36015", "36019", "36019", "36029", 
                   "36031", "36031", "36033", "36037", "36037", "36037", 
                   "36041", "36043", "36045", "36049", "36051", "36055", 
                   "36063", "36065", "36067", "36069", "36073", "36075", 
                   "36089", "36097", "36099", "36101", "36107", "36109", 
                   "36117", "36121", "36123", "42003", "42005", "42007", 
                   "42009", "42013", "42015", "42019", "42021", "42023",
                   "42027", "42031", "42033", "42035", "42037", "42039", 
                   "42047", "42049", "42051", "42053", "42057", "42059", 
                   "42061", "42063", "42065", "42067", "42073", "42081", 
                   "42083", "42085", "42087", "42093", "42097", "42099", 
                   "42104", "42105", "42109", "42111", "42113", "42117", 
                   "42119", "42121", "42123", "42125", "42129", "43031", 
                   "43063", "51003", "51025", "51029", "51040", "51049", 
                   "51064", "51065", "51068", "51069", "51079", "51081", 
                   "51084", "51084", "51093", "51111", "51113", "51139", 
                   "51147", "51171", "51175", "51181", "51183", "51540", 
                   "51550", "51595", "51620", "51684", "51710", "51740", 
                   "51800", "51810", "51840", "54001", "54001", "54027", 
                   "54031", "54139", "54140", "51011", "51017", "51019", 
                   "51021", "51035", "51037", "51045", "51071", "51077",
                   "51083", "51091", "51105", "51117", "51121", "51125", 
                   "51141", "51143", "51155", "51165", "51185", "51189", 
                   "51191", "51197", "51599", "51660", "51820", "51169", 
                   "51167", "51027", "51173", "51051", "51195", "51220", 
                   "51520", "51640", "51750", "51063", "51067", "51023", 
                   "51890", "51590", "51031", "51689", "51009", "51530", 
                   "51678", "51163", "51780", "51680", "51790", "51035", 
                   "51256", "51035", "51720", "51690", "51775", "51770",
                   "51015", "51161", "51089", "51080", "51580", "51005"]
gl_pa         = ["42049"]
peninsula     = ["26053","26131","26061","26083","26013","26071","26103",
                 "26003","26109","26041","26053","26956","26976","26033",
                 "26043","26053","26095","26097","20033","26043","26053",
                 "26153"]
add_to_metro  = ["09190","09120","54065","54003","54037"]
ohio_basin_al = ["01077","01083","01089","01033","01059","01079",
                 "01103","01071","01049","01195"]
ohio_basin_ms = ["28141"]
ohio_basin_il = ["17019","17183","17041","17045","17029","17023",
                 "17079","17033","17159","17101","17047","17165",
                 "17193","17059","17069","17151","17049","17025",
                 "17191","17185","17065","17035","17075"]
gl_in 		  = ["18127","18091","18141","18039","18151","18111",
                 "18073","18149","18099","18085","18113","18033",
                 "18089","18087"]
gl_oh 		  = ["39055","39085","39035","39103","39093","39043",
                 "39077","39033","39147","39143","39123","39095",
                 "39173","39063","39007","39003","39137","39065",
                 "39051","39171","39069","39161","39039","39125",
                 "39175","39173","37199"]
ohio_basin_oh = setdiff(get_geo_pop(["OH"]).geoid,gl_oh)
ohio_basin_pa = ["42039","42085","42073","42007","42125","42059",
                 "42123","42083","42121","42053","42047","42033",
                 "42021","42411","42065","42129","42051","42031",
                 "42005","42003","42019","42063","42111"]
ohio_basin_md = ["24023"]
ohio_basin_nc = ["37039","37043","37075","37113","37087","37099",
                 "37115","37021","37011","37009","37005","37173",
                 "37189","37121","37199","37089","37089"]
ohio_basin_va = ["51105","51169","51195","51120","51051","51027",
                 "51167","51191","51070","51021","51071","51155",
                 "51035","51195","51197","51173","51077","51185",
                 "51750","51640","51520","51720"]
ohio_basin_ga = ["13295","13111","13291","13241","13083","13111"]
miss_basin_ky = ["21039","21105","21083","21039","21105","21075",
                 "23007","21145","21007"]
miss_basin_tn = ["47095","47131","47069","47079","47045","47053",
                 "47017","47097","47033","47113","47077","47023",
                 "47157","47047","47069","47109","47023","46069",
                 "47183","47075","47166","47167"]
ms_east_la    = ["22125","22091","22058","22117","22033","22063",
                 "22103","22093","22095","22029","22051","22075",
                 "22087","22037","22105","22051","22071","22089",
                 "22093"]
south_fl      = ["12075","12083","12107","12035","12127","12117",
                 "12053","12119","12069","12095","12009","12101",
                 "12103","12057","12105","12097","12009","12081",
                 "12115","12097","12061","12049","12093","12061",
                 "12027","12111","12015","12043","12085","12071",
                 "12027","12071","12051","12099","12021","12011",
                 "12087","12086","12055","12017"]
metro_to_gl   = ["23003", "23029", "36009", 
                 "36011", "36013", "36014", "36019", "36029",
                 "36031", "36033", "36037", "36037", "36037", 
                 "36041", "36043", "36045", "36049", "36051",
                 "36055", "36063", "36065", "36067", "36069", 
                 "36073", "36075", "36089", "36099", "36117", 
                 "36121"]
mo_basin_ia   = ["19119","19143","19167","19141","19077",
                 "19149","19047","19035","19151","19041",
                 "19193","19071","19173","19021","19093",
                 "19161","19133","19145","19085","19165",
                 "19009","19155","19029","19129","19137",
                 "19003","19059"]
ms_basin_ia   = ["19043", "19007", "19005", "19195", "19045",
                 "19055", "19189", "19125", "19073", "19027",
                 "19117", "19051", "19157", "19177", "19123", 
                 "19099", "19163", "19063", "19187", "19013",
                 "19135", "19017", "19069", "19127", "19109", 
                 "19019", "19103", "19159", "19097", "19171", 
                 "19025", "19057", "19075", "19033", "19083", 
                 "19147", "19111", "19023", "19179", "19087", "19065", 
                 "19183", "19061", "19031", "19101", "19079", "19107", 
                 "19153", "19049", "19001", "19131", "19011", "19175", 
                 "19067", "19039", "19037", "19015", "19091", "19139", 
                 "19089", "19191", "19169", "19081", "19121", "19197", 
                 "19053", "19185", "19105", "19113", "19095", "19115", 
                 "19181"]
mo_basin_mn   = ["27117","27133","27195"]
mo_basin_mo   = ["29005","29087","29147","29003","29021",
                 "29165","29047","29049","29063","29075",
                 "29177","29025","29061","29081","29041",
                 "29089","29175","29121","29001","29197",
                 "29027","29007","29137","29205","29227",
                 "29019","29139","29163","29173","29127",
                 "29111","29045","29183","29189","28510",
                 "29027","29129","29079","29117","29033",
                 "29171","29211","29115","29199","29103",
                 "29510","29219","25215"]
ms_basin_mo   = ["29071","29065","29099","29221","29093",
                 "29179","29031","29223","29207","29069",
                 "29155","29143","29133","29201","29017",
                 "29179","29187","29123","29186",
                 "29157"]
ar_basin_mo   = ["29011","29145","29119","29109","29009",
                 "29077","29043","29209","29113","29067",
                 "29227","29997","29153","29091","29149",
                 "29181","29213","29017","29123","29187",
                 "29097"]
ar_basin_la   = ["22023","22019","22011","22115","22069",
                 "22085","22031"]
ar_basin_tx   = ["48","48","48","48","48",
                 "48","48","48","48","48",
                 "48","48","48","48","48",
                 "48","48","48","48","48",
                 "48","48"]
rio_basin_tx  = ["48141","48229","48109","48243","48377",
                 "48301","48389","48371","48043","48443",
                 "48465","48105","48103","48475"]
rio_basin_nm  = ["35039","35056","35049","35028","35043",
                 "35001","35053","35013","35051","35061"]
rio_basin_co  = ["08023","08021","08105","08003","08109"]
east_basin_tx = ["48","48","48","48","48"]

take_from_concordia = ["09190","09120","23003","23029"]
add_to_concordia    = ["36031","36019"]




